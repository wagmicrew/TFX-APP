# QR Code Specification for TrafikskolaX

This document specifies the format and generation requirements for QR codes used in the TrafikskolaX mobile app.

## Overview

The TrafikskolaX app uses QR codes for two purposes:
1. **School Configuration QR Code** - For initial app setup
2. **Quick Login QR Code** - For fast authentication from student dashboard

---

## 1. School Configuration QR Code

### Purpose
Allows students to quickly configure the app by scanning a QR code on the school's website instead of manually entering the domain.

### Where to Display
Place this QR code on:
- School website homepage
- Student portal login page
- Marketing materials
- Welcome emails to new students

### QR Code Data Format (JSON)

```json
{
  "type": "school_config",
  "domain": "dintrafikskolahlm.se",
  "version": 1
}
```

### Field Specifications

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | Yes | Must be exactly `"school_config"` |
| `domain` | string | Yes | Your school's domain (without https://) |
| `version` | number | Yes | Schema version (currently `1`) |

### Example

For school domain `dintrafikskolahlm.se`, the QR code should encode:

```json
{"type":"school_config","domain":"dintrafikskolahlm.se","version":1}
```

### Generation Instructions

**Option 1: Online QR Generator**
1. Go to https://www.qr-code-generator.com/ or similar
2. Select "Text" type
3. Paste the JSON string (minified, no spaces)
4. Generate and download as PNG/SVG
5. Recommended size: 300x300px minimum

**Option 2: Using AI (ChatGPT/Claude/etc.)**

**Prompt:**
```
Generate a QR code for TrafikskolaX school configuration with the following JSON data:
{"type":"school_config","domain":"dintrafikskolahlm.se","version":1}

Please create a high-quality QR code (at least 500x500px) that can be easily scanned by mobile cameras. Use black on white background for best contrast.
```

**Option 3: Programmatic Generation (Node.js)**

```javascript
const QRCode = require('qrcode');

const data = {
  type: 'school_config',
  domain: 'dintrafikskolahlm.se',
  version: 1
};

QRCode.toFile('school-config-qr.png', JSON.stringify(data), {
  width: 500,
  margin: 2,
  color: {
    dark: '#000000',
    light: '#FFFFFF'
  }
}, (err) => {
  if (err) console.error(err);
  console.log('QR code generated!');
});
```

**Option 4: Python**

```python
import qrcode
import json

data = {
    "type": "school_config",
    "domain": "dintrafikskolahlm.se",
    "version": 1
}

qr = qrcode.QRCode(
    version=1,
    error_correction=qrcode.constants.ERROR_CORRECT_L,
    box_size=10,
    border=4,
)
qr.add_data(json.dumps(data))
qr.make(fit=True)

img = qr.make_image(fill_color="black", back_color="white")
img.save("school-config-qr.png")
```

### Design Recommendations

- **Size**: Minimum 300x300px, recommended 500x500px
- **Colors**: Black on white background (best for scanning)
- **Margin**: At least 4 modules (quiet zone around QR code)
- **Error Correction**: Medium (15%) or High (30%)
- **Format**: PNG or SVG
- **Branding**: You can add your school logo in the center (max 20% of QR area)

### HTML Implementation Example

```html
<div class="qr-code-section">
  <h2>Snabbkonfiguration av TrafikskolaX-appen</h2>
  <p>Skanna denna QR-kod med din mobilkamera för att automatiskt konfigurera appen:</p>
  <img 
    src="/images/trafikskola-qr-config.png" 
    alt="Skanna för att konfigurera appen"
    style="width: 300px; height: 300px; border: 4px solid #000; border-radius: 12px;"
  />
  <p><small>Eller ange domänen manuellt: dintrafikskolahlm.se</small></p>
</div>
```

---

## 2. Quick Login QR Code

### Purpose
Allows authenticated students to quickly log in to the mobile app by scanning a QR code from their web dashboard, eliminating the need to enter email/OTP.

### Where to Display
- Student dashboard (after login)
- My Account page
- Mobile-specific section of student portal

### QR Code Data Format (JSON)

```json
{
  "type": "quick_login",
  "token": "qlt_a8f3n29dk3n2kd93jd82nd9kd83nd92kd",
  "expires": 1705320000,
  "version": 1
}
```

### Field Specifications

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | Yes | Must be exactly `"quick_login"` |
| `token` | string | Yes | Single-use token generated by your backend |
| `expires` | number | Yes | Unix timestamp when token expires |
| `version` | number | Yes | Schema version (currently `1`) |

### Token Generation Requirements

**CRITICAL SECURITY REQUIREMENTS:**

1. **Single-use token**: Each token can only be used ONCE
2. **Short expiration**: Token should expire after 5 minutes
3. **User-specific**: Token must be tied to specific student account
4. **Cryptographically random**: Use secure random generation (min 32 characters)
5. **Prefix convention**: Use `qlt_` prefix (quick login token)
6. **Store securely**: Store token hash in database, not plaintext

### Backend Implementation Example (Node.js)

```javascript
const crypto = require('crypto');

// Generate quick login token
function generateQuickLoginToken(studentId) {
  const token = 'qlt_' + crypto.randomBytes(32).toString('hex');
  const expiresAt = Math.floor(Date.now() / 1000) + (5 * 60); // 5 minutes
  
  // Store in database (with hash)
  const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
  db.storeQuickLoginToken({
    studentId,
    tokenHash,
    expiresAt,
    used: false
  });
  
  return {
    type: 'quick_login',
    token,
    expires: expiresAt,
    version: 1
  };
}

// Verify quick login token (called by mobile app)
async function verifyQuickLoginToken(token) {
  const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
  const record = await db.findQuickLoginToken(tokenHash);
  
  if (!record) {
    throw new Error('Invalid token');
  }
  
  if (record.used) {
    throw new Error('Token already used');
  }
  
  if (Date.now() / 1000 > record.expiresAt) {
    throw new Error('Token expired');
  }
  
  // Mark as used
  await db.markTokenAsUsed(tokenHash);
  
  // Generate full session for mobile
  return generateSessionForStudent(record.studentId);
}
```

### Dynamic QR Code Generation on Dashboard

```javascript
// React component example
function QuickLoginQR({ studentId }) {
  const [qrData, setQrData] = useState(null);
  
  useEffect(() => {
    async function generateQR() {
      const response = await fetch('/api/student/generate-quick-login-qr', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
      const data = await response.json();
      setQrData(JSON.stringify(data));
    }
    
    generateQR();
    // Refresh every 4 minutes (before expiration)
    const interval = setInterval(generateQR, 4 * 60 * 1000);
    return () => clearInterval(interval);
  }, [studentId]);
  
  if (!qrData) return <div>Generating QR code...</div>;
  
  return (
    <div className="quick-login-section">
      <h3>Snabbinloggning med QR</h3>
      <p>Skanna denna kod med TrafikskolaX-appen för att logga in direkt:</p>
      <QRCodeSVG value={qrData} size={256} />
      <p className="expires-text">
        Koden upphör om 5 minuter
      </p>
    </div>
  );
}
```

### Security Notes

⚠️ **IMPORTANT SECURITY CONSIDERATIONS:**

1. **Never reuse tokens** - Each scan must invalidate the token
2. **Rate limiting** - Limit QR generation to prevent abuse (max 10/hour per student)
3. **Bind to session** - Only logged-in students can generate QR codes
4. **Monitor usage** - Log all quick login attempts for security audits
5. **IP validation** (optional) - Validate that scan happens from similar location as generation
6. **Invalidate on logout** - All active quick login tokens should be invalidated when student logs out from web

### Mobile App Quick Login Flow

```
1. Student opens mobile app
2. Taps "Quick Login with QR"
3. Camera opens and scans QR code
4. App extracts token and sends to: POST /api/auth/quick-login
5. Backend validates token and returns session
6. App stores session and navigates to dashboard
```

---

## 3. AI Prompts for QR Code Generation

### Prompt for School Configuration QR Code

```
I need a QR code for my driving school mobile app configuration. 

Please generate a QR code that encodes this JSON data:
{"type":"school_config","domain":"dintrafikskolahlm.se","version":1}

Requirements:
- Black QR code on white background
- Size: 500x500 pixels minimum
- High error correction level
- Clear quiet zone (white border) around the code
- Clean, professional appearance suitable for a website

The QR code will be displayed on our school website to help students quickly configure our mobile app.
```

### Prompt for Quick Login QR Code Design (UI)

```
Design a web dashboard section for a driving school student portal that displays a QR code for quick mobile login.

Requirements:
- Modern, clean design matching our black and red color scheme
- Display a QR code (256x256px) prominently
- Include heading: "Quick Login with QR"
- Subtext: "Scan this code with the TrafikskolaX app to log in instantly"
- Show expiration timer: "Code expires in 4:32"
- Refresh button to generate new code
- Subtle animation or pulse effect to draw attention
- Mobile-responsive layout
- Professional appearance suitable for a driving school

Style: Modern, minimal, trustworthy, easy to understand for non-technical users.
```

---

## 4. Testing Your QR Codes

### Manual Testing Checklist

**School Configuration QR:**
- [ ] QR code scans successfully with phone camera
- [ ] App extracts correct domain
- [ ] App connects to school API successfully
- [ ] Theme loads correctly after configuration
- [ ] QR code is visible and scannable on all devices (desktop, tablet, mobile)

**Quick Login QR:**
- [ ] QR code generates within 2 seconds
- [ ] Token is unique for each generation
- [ ] Scanning logs in correct student
- [ ] Token expires after 5 minutes
- [ ] Used token cannot be scanned again
- [ ] QR refreshes automatically before expiration
- [ ] Logout invalidates all active tokens

### Test QR Data

For testing purposes, use these example payloads:

**Test School Config:**
```json
{"type":"school_config","domain":"test.trafikskola.se","version":1}
```

**Test Quick Login (will fail without valid backend):**
```json
{"type":"quick_login","token":"qlt_test_token_for_development_only","expires":9999999999,"version":1}
```

---

## 5. FAQ

### Q: Can I use URL shorteners for QR codes?
**A:** No. The app expects direct JSON data, not URLs. Encoding JSON directly in the QR code is more secure and faster.

### Q: Can I brand the QR code with our school logo?
**A:** Yes, but keep the logo small (max 20% of QR area) and ensure the QR code still scans reliably. Test thoroughly on different devices.

### Q: How often should quick login QR codes refresh?
**A:** Automatically refresh every 4 minutes (before the 5-minute expiration) to provide seamless experience.

### Q: What if a student takes a screenshot of the quick login QR?
**A:** The token is single-use and expires in 5 minutes, so screenshots quickly become useless. This is intentional for security.

### Q: Can I generate QR codes server-side?
**A:** For school config QR, generate once and store as image file. For quick login QR, generate dynamically on each dashboard load with fresh token.

### Q: What QR code error correction level should I use?
**A:** Use Medium (15%) or High (30%) error correction. This allows for minor damage or logo overlay while maintaining scannability.

---

## Support

If you have questions about QR code implementation, contact the TrafikskolaX development team or refer to the main API documentation.
